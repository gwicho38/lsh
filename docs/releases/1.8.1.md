# Release Notes: v1.8.1

**Release Date:** 2024-11-24
**Type:** Hotfix

## üêõ Bug Fixes

### Fixed Double Repo-Prefix Bug in Force-Rekey

**Issue**: When using `lsh sync --force-rekey`, the environment name was being double-prefixed with the repository name, causing secrets to be stored in the wrong location.

**Example of the bug:**
```
# Expected:  lsh_test_repo_dev
# Actual:    lsh_test_repo_lsh_test_repo_dev (WRONG!)
```

**Root Cause**: In `src/lib/secrets-manager.ts:720`, the `smartSync()` method was passing `effectiveEnv` (already repo-aware) to `push()`, which caused the repo prefix to be applied twice.

**Fix**: Changed line 720 to pass the original `environment` parameter instead of `effectiveEnv`, allowing `push()` to apply the repo-aware transformation once.

```typescript
// Before (BUG):
await this.push(envFilePath, effectiveEnv, true);

// After (FIXED):
await this.push(envFilePath, environment, true);
```

## üìä Impact

This bug affected users who:
- Used `lsh sync --force-rekey` to re-encrypt secrets
- Were working in git repositories
- Had repo-aware environment naming enabled (default)

## üîß Migration

If you were affected by this bug (v1.8.0 only):

### Step 1: Clean up the bad environment on all hosts
```bash
# List what environments exist
lsh env

# You may see both:
# - lsh_test_repo_dev (correct)
# - lsh_test_repo_lsh_test_repo_dev (bug - remove this)

# Clean up cache
rm -rf ~/.lsh/secrets-cache/
```

### Step 2: Re-push from the primary host
```bash
# On Host A (primary host with correct secrets)
lsh push --force --env dev
```

### Step 3: Pull on other hosts
```bash
# On Host B (secondary hosts)
lsh pull --env dev
```

## üì¶ Installation

```bash
npm install -g lsh-framework@1.8.1
```

Or update existing installation:
```bash
npm update -g lsh-framework
```

## üôè Credits

Thanks to the user who reported this issue immediately after v1.8.0 release, allowing us to fix it quickly!

## Related

- v1.8.0: Initial release with `--force-rekey` feature
- Issue: Double repo prefix when using force-rekey
