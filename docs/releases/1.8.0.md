# Release Notes: v1.8.0

**Release Date:** 2024-11-24

## Overview

This release improves the user experience when encountering encryption key mismatches by adding a new `--force-rekey` option to the `lsh sync` command, and fixes all command syntax references throughout the codebase to use the correct modern command format.

## üöÄ New Features

### Force Re-keying Option (`--force-rekey`)

Added `--force-rekey` flag to `lsh sync` command to automatically re-encrypt cloud secrets with the current local encryption key when a key mismatch is detected.

**Usage:**
```bash
lsh sync --force-rekey
```

**Behavior:**
- Detects encryption key mismatch between local and cloud
- Automatically pushes local `.env` file to cloud with current encryption key
- Validates local `.env` exists before proceeding
- Provides clear success/error messages

**Use Case:**
When you have a valid `.env` file locally but the cloud secrets were encrypted with a different key, instead of manually running `lsh push -f`, you can now use `lsh sync --force-rekey` for a seamless experience.

## üêõ Bug Fixes

### Fixed Command Syntax References

Updated all command references throughout the codebase from the old `lsh lib secrets <command>` format to the correct modern `lsh <command>` format.

**Commands Fixed:**
- `lsh lib secrets push` ‚Üí `lsh push`
- `lsh lib secrets pull` ‚Üí `lsh pull`
- `lsh lib secrets create` ‚Üí `lsh create`
- `lsh lib secrets key` ‚Üí `lsh key`
- `lsh lib secrets sync` ‚Üí `lsh sync`

**Files Modified:**
- `src/lib/secrets-manager.ts` - 11 occurrences fixed
- `src/services/secrets/secrets.ts` - 1 occurrence fixed

**Affected Areas:**
- Error messages during key mismatch
- Suggestions in legacy sync mode
- Help text in `create` command
- Destructive change warnings

## üìù Improvements

### Enhanced Error Messaging

Improved the encryption key mismatch error message to provide three clear options:

```
‚ö†Ô∏è  Encryption key mismatch!
   The local key does not match the cloud storage.

   Options:
   1. Use the original key (recommended if you have it)
   2. Re-encrypt with current key: lsh push -f .env -e dev
   3. Re-key during sync: lsh sync --force-rekey -f .env -e dev
```

Previously, the error only suggested option 2 with incorrect command syntax.

## üîß Technical Changes

### API Changes

**`SecretsManager.smartSync()` Method Signature:**
```typescript
// Before
async smartSync(
  envFilePath: string = '.env',
  environment: string = 'dev',
  autoExecute: boolean = true,
  loadMode: boolean = false,
  force: boolean = false
): Promise<void>

// After
async smartSync(
  envFilePath: string = '.env',
  environment: string = 'dev',
  autoExecute: boolean = true,
  loadMode: boolean = false,
  force: boolean = false,
  forceRekey: boolean = false  // NEW PARAMETER
): Promise<void>
```

### Implementation Details

**Force Re-key Logic (src/lib/secrets-manager.ts:706-733):**
1. Checks if cloud exists and key mismatch detected
2. If `forceRekey` flag is true:
   - Validates local `.env` exists
   - Pushes local secrets to cloud with force flag
   - Updates cloud encryption to use current local key
3. If `forceRekey` flag is false:
   - Shows error message with three options
   - Returns without making changes

## üìä Diff Summary

### Modified Files

**src/services/secrets/secrets.ts:**
- Added `--force-rekey` option to sync command (line 296)
- Updated command help text (line 277)
- Pass `forceRekey` parameter to `smartSync()` (line 305)

**src/lib/secrets-manager.ts:**
- Updated method signature to accept `forceRekey` parameter (line 649)
- Implemented force-rekey logic (lines 706-733)
- Fixed 11 command syntax references throughout file:
  - Line 209-210: Destructive change warning
  - Line 760: Create command suggestions
  - Line 780: Push suggestions
  - Line 800: Pull suggestions
  - Line 841, 854: Sync mode suggestions
  - Lines 928, 936, 941, 946, 957, 960: Legacy sync suggestions

## üîÑ Migration Guide

No breaking changes. This is a backwards-compatible feature addition.

### For Users

If you previously worked around key mismatches with manual commands:
```bash
# Old workflow
lsh sync  # Error: key mismatch
lsh lib secrets push -f .env -e dev  # Manual fix

# New workflow
lsh sync --force-rekey  # One command!
```

### For Developers

If you're calling `SecretsManager.smartSync()` programmatically, the new `forceRekey` parameter is optional and defaults to `false`, maintaining backward compatibility.

## üì¶ Installation

```bash
npm install -g lsh-framework@1.8.0
```

Or update existing installation:
```bash
npm update -g lsh-framework
```

## üôè Credits

This release addresses user feedback about confusing error messages and improves the overall developer experience when managing secrets across multiple environments.

## üìö Related Documentation

- [Secrets Guide](../features/secrets/SECRETS_GUIDE.md)
- [Quick Reference](../features/secrets/SECRETS_QUICK_REFERENCE.md)
- [Security Best Practices](../development/SECURITY.md)
