# Release Notes: lsh-framework v1.3.1

**Release Date:** November 15, 2025
**Previous Version:** 1.3.0
**Type:** Patch Release (Bug Fix & Enhancement)

## üéØ Overview

This patch release adds intelligent file type detection to the `lsh set` command, automatically determining whether to use the `export` prefix based on the target file type. This ensures correct formatting for `.env` files (no export), shell scripts (with export), and direnv files.

## ‚ú® Enhancements

### Smart File Format Detection

The `lsh set` command now automatically detects the target file type and applies the appropriate format:

#### Files WITHOUT `export` prefix:
- `.env` - Standard environment files
- `.env.*` - Environment-specific files (`.env.development`, `.env.production`, etc.)
- All other files (default)

#### Files WITH `export` prefix:
- `.sh`, `.bash`, `.zsh` - Shell scripts
- `.bashrc`, `.zshrc` - Shell RC files
- `.profile`, `.bash_profile`, `.zprofile` - Shell profile files
- `.envrc`, `*.envrc` - Direnv configuration files

### Examples

**Setting variables in .env file (NO export):**
```bash
lsh set DATABASE_URL "postgres://localhost:5432/db"
# Result in .env:
# DATABASE_URL=postgres://localhost:5432/db
```

**Setting variables in shell script (WITH export):**
```bash
lsh set DATABASE_URL "postgres://localhost:5432/db" -f setup.sh
# Result in setup.sh:
# export DATABASE_URL=postgres://localhost:5432/db
```

**Setting variables in .envrc (WITH export):**
```bash
lsh set API_KEY "secret123" -f .envrc
# Result in .envrc:
# export API_KEY=secret123
```

## üîß Technical Changes

### Files Modified

**`src/services/secrets/secrets.ts`**

Added three new functions:

1. **`shouldUseExport(filePath: string): boolean`** (lines 605-631)
   - Detects file type based on extension and filename
   - Returns `true` for shell scripts/RC files, `false` for .env files

2. **`formatEnvLine(key: string, value: string, filePath: string): string`** (lines 634-639)
   - Formats environment variable lines with or without `export`
   - Automatically quotes values with spaces or special characters

3. **Modified `setSingleSecret()`** (lines 644-687)
   - Updated regex to match lines with or without `export` prefix: `/^(?:export\s+)?([^=]+)=(.*)$/`
   - Uses `formatEnvLine()` to output correct format
   - Preserves file format when updating existing keys

4. **Modified `batchSetSecrets()`** (lines 692-860)
   - Updated input parsing to accept lines with or without `export`
   - Uses `formatEnvLine()` for all output formatting
   - Correctly handles mixed input formats

## üß™ Testing

### Test Coverage

All file types tested and verified:
```bash
# .env file ‚Üí No export
lsh set DATABASE_URL "postgres://..." -f .env
‚úÖ DATABASE_URL=postgres://...

# .envrc file ‚Üí With export
lsh set DATABASE_URL "postgres://..." -f .envrc
‚úÖ export DATABASE_URL=postgres://...

# .bashrc file ‚Üí With export
lsh set DATABASE_URL "postgres://..." -f ~/.bashrc
‚úÖ export DATABASE_URL=postgres://...

# Shell script ‚Üí With export
lsh set DATABASE_URL "postgres://..." -f setup.sh
‚úÖ export DATABASE_URL=postgres://...
```

### Batch Mode Testing

```bash
# Input with export ‚Üí .env file (strips export)
echo "export LSH_SECRETS_KEY=abc123" | lsh set -f .env
‚úÖ Result: LSH_SECRETS_KEY=abc123

# Input with export ‚Üí .envrc file (keeps export)
echo "export LSH_SECRETS_KEY=abc123" | lsh set -f .envrc
‚úÖ Result: export LSH_SECRETS_KEY=abc123
```

## üîÑ Breaking Changes

None. This is a backward-compatible enhancement.

- Existing `.env` files continue to work without `export` prefix
- Shell scripts continue to work with `export` prefix
- Input parsing now accepts both formats universally

## üêõ Bug Fixes

- Fixed: `lsh set` now correctly handles input with `export` prefix
  - Previously rejected lines starting with `export`
  - Now accepts and processes them correctly

- Fixed: Format consistency based on file type
  - `.env` files no longer accidentally get `export` prefix
  - Shell scripts now correctly include `export` prefix

## üìä Diff Summary

```
Files Changed:
- src/services/secrets/secrets.ts    (+95 lines, -30 lines)

Functions Added:
- shouldUseExport()
- formatEnvLine()

Functions Modified:
- setSingleSecret()
- batchSetSecrets()

Total: 1 file modified
Lines: +95 insertions, -30 deletions
```

## üì¶ Installation

```bash
npm install -g lsh-framework@1.3.1
# or
npm update -g lsh-framework
```

## üîú Future Improvements

- Add `--format` flag to manually override auto-detection
- Support for additional file formats (e.g., `.properties`, `.ini`)
- Validation warnings when file format seems incorrect

## üë• Contributors

- Claude Code

---

**Full Changelog:** v1.3.0...v1.3.1
