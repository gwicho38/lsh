# Release Notes: LSH v0.8.2

**Release Date:** October 30, 2025
**Previous Version:** v0.8.1

## Overview

This release introduces **Smart Sync** - an intelligent, automatic secrets management system that revolutionizes how developers handle environment variables. With git repository detection, automatic setup, and one-command sync-and-load functionality, managing secrets across machines has never been easier.

## 🎯 Major Features

### Smart Sync for Secrets Management

**Auto-Detection & Setup**
- Automatically detects git repositories and uses repo name for namespace isolation
- Generates encryption keys automatically if missing
- Creates `.env` files from `.env.example` templates or from scratch
- Adds `.env` to `.gitignore` automatically
- No manual configuration required!

**Intelligent Synchronization**
- Analyzes local vs cloud state
- Automatically pushes or pulls based on what's newer
- Creates backups before overwriting
- Verifies encryption key matches

**Repository-Aware Namespacing**
- Secrets automatically namespaced by repo name (e.g., `my-app_dev`, `other-app_dev`)
- Multiple projects can use same environment names without conflicts
- Seamless isolation between projects

### Load Mode (`--load` flag)

**One-Command Sync AND Load**
```bash
eval "$(lsh lib secrets sync --load)"
```
- Syncs secrets (push/pull as needed)
- Outputs eval-able export commands
- Progress messages go to stderr (doesn't interfere with eval)
- All secrets loaded into current shell instantly

## 📦 New Files

### Core Implementation

**`src/lib/git-utils.ts`**
- Git repository detection utilities
- Extracts repo name, remote URL, current branch
- Finds `.env.example` files
- Manages `.gitignore` entries
- Full test coverage (28 tests)

**`src/__tests__/git-utils.test.ts`**
- Comprehensive test suite for git utilities
- Tests repo detection, URL parsing, .gitignore management
- Handles macOS symlink edge cases

### Documentation

**`docs/features/secrets/SMART_SYNC_GUIDE.md`**
- Complete Smart Sync user guide
- Usage examples for all scenarios
- Command options and workflows
- Troubleshooting and FAQ

## 🔧 Enhanced Files

### `src/lib/secrets-manager.ts`

**New Methods:**
- `smartSync()` - Automatic sync with intelligent decision-making
- `getRepoAwareEnvironment()` - Repo-based namespace generation
- `ensureEncryptionKey()` - Automatic key generation and storage
- `createEnvFromExample()` - Template-based `.env` creation
- `generateExportCommands()` - Shell export command generation
- `showLoadInstructions()` - User guidance helper

**Enhanced Functionality:**
- Git repository detection integration
- Load mode support (stderr for logs, stdout for exports)
- Improved status checking and reporting
- Legacy `sync()` method preserved for backward compatibility

### `src/services/secrets/secrets.ts`

**Command Enhancements:**
- Updated `sync` command with Smart Sync as default
- Added `--load` flag for sync-and-load workflow
- Added `--dry-run` flag for preview mode
- Added `--legacy` flag for old behavior
- Improved help text and descriptions

### Documentation Updates

**`docs/features/secrets/SECRETS_QUICK_REFERENCE.md`**
- Added Smart Sync quick start section
- Updated cheat sheet with new commands
- New recommended workflows

**`docs/features/secrets/SMART_SYNC_GUIDE.md`**
- Complete implementation guide
- Load mode examples and best practices
- Repository namespacing explanation

## 🚀 Usage Examples

### Before (v0.8.1)
```bash
# Manual multi-step process
lsh lib secrets key
echo "LSH_SECRETS_KEY=..." >> .env
lsh lib secrets push --env dev
# ... on another machine
lsh lib secrets pull --env dev
set -a; source .env; set +a
```

### After (v0.8.2)
```bash
# One command does everything!
lsh lib secrets sync
```

### With Load Mode (v0.8.2)
```bash
# Sync AND load in one command!
eval "$(lsh lib secrets sync --load)"
```

## 🔍 Detailed Changes

### Git Integration

**Repository Detection:**
```typescript
// Automatically detects:
- Git repo root path
- Repository name from remote URL
- Current branch name
- Presence of .env.example files
```

**Namespacing:**
```typescript
// Before: secrets stored as "dev"
// After: secrets stored as "my-app_dev"

getRepoAwareEnvironment("dev")
// Returns: "my-app_dev" if in git repo "my-app"
// Returns: "dev" if not in git repo
```

### Smart Decision Making

**Sync Logic:**
```
1. No encryption key? → Generate and save
2. No .env in .gitignore? → Add it
3. Check status:
   - No local, no cloud? → Create from template and push
   - Local only? → Push to cloud
   - Cloud only? → Pull to local
   - Both exist? → Sync newer to older
```

### Load Mode Implementation

**Export Generation:**
```bash
# Input: .env file
DATABASE_URL=postgresql://localhost:5432/db
API_KEY="secret with spaces"

# Output: Safe shell exports
export DATABASE_URL="postgresql://localhost:5432/db"
export API_KEY="secret with spaces"
```

**Special Character Handling:**
- Escapes: `\`, `"`, `$`, `` ` ``
- Preserves quotes and spaces
- Prevents command injection

## 🧪 Testing

**Test Coverage:**
- 28 new tests for `git-utils.ts` (100% passing)
- Tests handle macOS `/var` → `/private/var` symlink edge case
- Full integration with existing test suite
- All 205 tests passing

**Test Categories:**
- Repository detection
- URL parsing (HTTPS and SSH)
- Branch name extraction
- .env.example discovery
- .gitignore management
- Edge cases and error handling

## 📖 Documentation

**New Guides:**
- Complete Smart Sync guide with examples
- Load mode usage patterns
- Repository namespacing explanation
- Migration guide from manual workflow

**Updated References:**
- Quick reference cheat sheet
- Command option documentation
- Best practices and tips

## 🔄 Backward Compatibility

**Fully Compatible:**
- All existing commands work unchanged
- Manual `push`/`pull` commands still available
- Legacy `sync` behavior accessible via `--legacy` flag
- No breaking changes

**Migration Path:**
```bash
# Old way still works
lsh lib secrets push --env dev
lsh lib secrets pull --env dev

# New way is optional
lsh lib secrets sync
```

## 🐛 Bug Fixes

- Fixed path resolution for macOS symlinks in tests
- Improved error handling for missing git repositories
- Better validation of encryption key presence

## ⚡ Performance

**Improvements:**
- Single command replaces 5+ manual steps
- Parallel status checks (local + cloud)
- Efficient git command execution
- Minimal overhead for non-git directories

## 🔐 Security

**Enhanced Security:**
- Automatic `.gitignore` management prevents accidental commits
- Encryption key validation before operations
- Safe shell export with proper escaping
- No secrets exposed in process lists

## 💡 Best Practices

**Recommended Workflow:**
```bash
# Add to ~/.zshrc
alias load-secrets='eval "$(lsh lib secrets sync --load)"'

# Daily usage
cd ~/repos/my-app
load-secrets
npm start
```

## 📊 Statistics

- **New Files:** 3 (2 implementation + 1 test)
- **Modified Files:** 4
- **Lines Added:** ~800
- **Tests Added:** 28
- **Test Coverage:** 100% for new code
- **Documentation Pages:** 3 updated, 1 new

## 🔗 Related Issues

This release addresses user feedback regarding:
- Complex multi-step secrets setup
- Manual encryption key management
- No git repository awareness
- Separate sync and load operations

## 🚧 Known Limitations

- Load mode requires `eval` (shell limitation)
- Git detection only works in git repositories
- Encryption key must be same across team members

## 🎯 Future Enhancements

Potential future improvements:
- Multi-environment sync in one command
- Secrets rotation automation
- Team key distribution helpers
- Integration with cloud secret managers

## 📝 Commit Summary

```
feat: add Smart Sync for automatic secrets management

- Add git repository detection utilities
- Implement automatic encryption key generation
- Add repository-aware secret namespacing
- Create smart sync with intelligent push/pull decisions
- Add --load flag for sync-and-load workflow
- Ensure .env is in .gitignore automatically
- Create .env from .env.example templates
- Add comprehensive test suite (28 tests)
- Update documentation with Smart Sync guide
```

## 🙏 Acknowledgments

This release focuses on developer experience improvements based on real-world usage patterns and feedback.

---

**Full Changelog:** https://github.com/gwicho38/lsh-framework/compare/v0.8.1...v0.8.2
