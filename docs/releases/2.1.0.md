# Release Notes: v2.1.0

**Release Date:** 2024-11-24
**Type:** Minor Release - Major Feature Addition

## ğŸ‰ Major New Feature: True Multi-Host IPFS Sync

### Storacha Network Integration (Enabled by Default)

LSH now supports **true multi-host secrets sync** via Storacha (IPFS network) with **zero configuration** after a one-time email authentication.

**What's New**:
- âœ… **Default enabled** IPFS network sync (no configuration required)
- âœ… **One-time email authentication** per machine
- âœ… **Automatic upload** to IPFS network on `lsh push`
- âœ… **Automatic download** from IPFS network on `lsh pull` (if local cache miss)
- âœ… **Graceful fallback** to local cache if network unavailable
- âœ… **New CLI commands** for Storacha management

### What This Solves

**Before v2.1.0**:
```bash
# On Host A (MacBook)
cd my-project
lsh push --env dev        # âœ… Stored locally in ~/.lsh/secrets-cache/

# On Host B (Linux server)
cd my-project
lsh pull --env dev        # âŒ Error: Secrets not found
                          # Required manual Supabase setup
```

**After v2.1.0**:
```bash
# On Host A (MacBook) - One-time setup
lsh storacha login [email protected]
# âœ… Email verification â†’ payment plan â†’ space created

# Push secrets (automatic network sync)
cd my-project
lsh push --env dev        # âœ… Encrypted + uploaded to IPFS network
# ğŸ“¤ Uploaded to Storacha: bafkrei...
#    Gateway: https://bafkrei....ipfs.storacha.link
#    â˜ï¸  Synced to Storacha network

# On Host B (Linux server) - One-time setup
lsh storacha login [email protected]

# Pull secrets (automatic network download)
cd my-project
lsh pull --env dev        # âœ… Downloaded from IPFS network
# ğŸ“¥ Downloading from Storacha: bafkrei...
# âœ… Downloaded 245 bytes from Storacha
```

## ğŸ†• New CLI Commands

### Storacha Authentication
```bash
# One-time authentication (per machine)
lsh storacha login [email protected]

# Check authentication status
lsh storacha status
```

### Space Management
```bash
# Create a new Storacha space
lsh storacha space create my-project-secrets

# List all spaces
lsh storacha space list
```

### Network Sync Control
```bash
# Enable Storacha network sync (default: enabled)
lsh storacha enable

# Disable network sync (local cache only)
lsh storacha disable
```

## ğŸ”’ Security Features

- **AES-256 encryption before upload**: Secrets are encrypted locally before being uploaded to IPFS
- **Content-addressed storage**: IPFS CIDs ensure tamper-proof integrity
- **Shared encryption key**: Teams use `LSH_SECRETS_KEY` for decryption
- **No plaintext on network**: Only encrypted data is stored on IPFS

## ğŸ“‹ How It Works

### Push Flow (Host A)
```
.env file
   â†“ AES-256 encrypt with LSH_SECRETS_KEY
Encrypted data (local cache: ~/.lsh/secrets-cache/bafkrei...encrypted)
   â†“ Upload to Storacha network
IPFS CID (bafkrei...)
   â†“ Accessible via gateway
https://bafkrei....ipfs.storacha.link
```

### Pull Flow (Host B)
```
Check local cache (~/.lsh/secrets-cache/)
   â†“ Cache miss
Download from Storacha network (https://CID.ipfs.storacha.link)
   â†“ Store in local cache
Decrypt with LSH_SECRETS_KEY
   â†“ Write to disk
.env file
```

## ğŸš€ Quick Start

### First-Time Setup (Per Machine)

```bash
# 1. Install/update LSH
npm install -g lsh-framework@2.1.0

# 2. Generate encryption key (share with team)
lsh key
# Example output: lsh-key-a1b2c3d4e5f6...

# 3. Set encryption key (add to ~/.bashrc or ~/.zshrc)
export LSH_SECRETS_KEY=lsh-key-a1b2c3d4e5f6...

# 4. Authenticate with Storacha (one-time)
lsh storacha login [email protected]
# âœ… Check email â†’ verify â†’ select payment plan
# âœ… Default space "lsh-secrets" created automatically
```

### Daily Usage

```bash
# Push secrets (automatic IPFS sync)
cd my-project
lsh push --env dev
# âœ… Encrypted locally
# âœ… Cached in ~/.lsh/secrets-cache/
# âœ… Uploaded to Storacha network

# Pull secrets on another machine (automatic IPFS download)
cd my-project
lsh pull --env dev
# âœ… Downloads from IPFS if not cached
# âœ… Decrypts with LSH_SECRETS_KEY
# âœ… Writes to .env
```

## ğŸ“Š Technical Details

### New Files
- **`src/lib/storacha-client.ts`** (308 lines) - Storacha client wrapper
  - Email authentication with credential persistence
  - Space management (create, list, current)
  - Upload/download via Storacha network
  - Configuration management (~/.lsh/storacha-config.json)

- **`src/commands/storacha.ts`** (233 lines) - Storacha CLI commands
  - `lsh storacha login <email>`
  - `lsh storacha status`
  - `lsh storacha space create/list`
  - `lsh storacha enable/disable`

- **`__tests__/integration/storacha-multihost-sync.test.ts`** (262 lines)
  - 12 comprehensive tests covering multi-host sync scenarios
  - Default behavior validation
  - Error handling and fallback testing
  - Multi-environment support

### Modified Files
- **`src/lib/ipfs-secrets-storage.ts`**
  - Added Storacha upload in `push()` method (lines 97-110)
  - Added Storacha download fallback in `pull()` method (lines 139-160)
  - Graceful error handling with local cache fallback

- **`src/cli.ts`**
  - Registered Storacha commands (line 164)

### Default Behavior

**Storacha is enabled by default** unless explicitly disabled:

```typescript
// Environment variable override
export LSH_STORACHA_ENABLED=false  # Disables network sync

// Or via CLI
lsh storacha disable               # Disables network sync
```

### Configuration Storage
- **Storacha credentials**: `~/.lsh/storacha-config.json`
- **Storacha agent store**: `~/.lsh/.storacha/` (managed by @storacha/client)
- **Local cache**: `~/.lsh/secrets-cache/`
- **Metadata**: `~/.lsh/secrets-metadata.json`

## ğŸ§ª Testing

### New Test Suite
Added comprehensive multi-host sync integration tests:

```bash
npm test -- storacha-multihost-sync
```

**Test Coverage**:
- âœ… Default behavior (Storacha enabled by default)
- âœ… Multi-host sync scenario (Host A push â†’ Host B pull)
- âœ… Storacha integration points (upload/download)
- âœ… Client API (authentication, spaces, status)
- âœ… Error handling (graceful fallback)
- âœ… Multi-environment support

**Results**: All 12 tests passing âœ…

### Full Test Suite
```bash
npm test
# Test Suites: 1 skipped, 20 passed, 20 of 21 total
# Tests:       28 skipped, 477 passed, 505 total
```

## ğŸ”„ Migration from v2.0.2

### Automatic Migration
No migration required! Existing local cache continues to work:

```bash
# Update LSH
npm update -g lsh-framework@2.1.0

# Verify version
lsh --version  # Should show 2.1.0

# Your existing secrets still work
lsh list       # âœ… Shows local secrets
lsh push       # âœ… Now also uploads to Storacha network
```

### Optional: Enable Network Sync
To enable multi-host sync, authenticate once per machine:

```bash
# One-time setup
lsh storacha login [email protected]

# Verify
lsh storacha status
# âœ… Authentication: Authenticated
# âœ… Network Sync: Enabled
```

### Backward Compatibility
- âœ… Local cache still works (offline access)
- âœ… Supabase integration still supported
- âœ… All existing commands work unchanged
- âœ… Existing `.env` files unaffected

## ğŸ†š Comparison: Storacha vs Supabase

| Feature | Storacha (v2.1.0) | Supabase (existing) |
|---------|-------------------|---------------------|
| **Setup** | One-time email auth | Manual DB setup + credentials |
| **Cost** | Free tier (5GB) â†’ paid plans | Free tier â†’ paid plans |
| **Network** | IPFS (decentralized) | PostgreSQL (centralized) |
| **Offline** | âœ… Local cache | âœ… Local cache |
| **Default** | âœ… Enabled | âš™ï¸ Opt-in |
| **Speed** | ğŸŒ Gateway download | ğŸš€ Direct DB query |
| **Use Case** | Simple multi-host sync | Team collaboration + audit logs |

**Recommendation**:
- **Storacha**: Best for simple multi-host sync (2-5 machines)
- **Supabase**: Best for teams (10+ users, audit logs, role-based access)

## ğŸ“š Documentation Updates

Updated documentation:
- **README.md**: Added Storacha feature section
- **SECRETS_GUIDE.md**: Added multi-host sync with Storacha
- **SECRETS_QUICK_REFERENCE.md**: Added Storacha commands

## ğŸ› Known Issues

None currently known. If you encounter issues, please report at:
https://github.com/gwicho38/lsh/issues

## ğŸ”® Future Enhancements

- **Automatic space selection**: Auto-select space based on git repo
- **Bandwidth optimization**: Delta uploads for large .env files
- **Conflict resolution**: Merge conflicts for concurrent edits
- **Team spaces**: Shared spaces for organizations

## ğŸ“¦ Installation

```bash
# New installation
npm install -g lsh-framework@2.1.0

# Upgrade from any version
npm update -g lsh-framework@2.1.0

# Verify
lsh --version  # Should show 2.1.0
```

## ğŸ™ Acknowledgments

This release implements the long-awaited IPFS network sync feature mentioned in v2.0.2 release notes as "planned." Special thanks to the Storacha team for their excellent IPFS client library.

## ğŸ“ˆ Full Changelog

**From v2.0.2 â†’ v2.1.0**:

### Added
- Storacha/IPFS network integration (enabled by default)
- `lsh storacha login <email>` command
- `lsh storacha status` command
- `lsh storacha space create/list` commands
- `lsh storacha enable/disable` commands
- Automatic IPFS upload on `lsh push`
- Automatic IPFS download on `lsh pull`
- Comprehensive multi-host sync tests (12 tests)
- Storacha client wrapper (`src/lib/storacha-client.ts`)
- Storacha CLI commands (`src/commands/storacha.ts`)

### Changed
- `lsh push` now uploads to IPFS network (if authenticated)
- `lsh pull` now downloads from IPFS network (if cache miss)
- IPFS storage is now true network storage (not just local)

### Fixed
- None (hotfix release v2.0.2 fixed the last known issue)

**GitHub**: https://github.com/gwicho38/lsh/compare/v2.0.2...v2.1.0

---

**Welcome to true multi-host secrets sync!** ğŸ‰

Questions? Issues? Feature requests?
ğŸ‘‰ https://github.com/gwicho38/lsh/issues
