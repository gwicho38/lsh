# Release Notes: v2.2.4

**Release Date:** 2025-11-25
**Type:** Patch Release - Critical Bug Fix for Environment Naming

## üö® Critical Bug Fix: Environment Name Duplication in smartSync()

### Issue

In v2.2.3 and earlier, `lsh sync` failed with duplicated environment names when using repo-aware environment naming. This caused pull operations to fail with "No secrets found" errors.

**User Evidence (v2.2.3):**
```bash
# In git repo "lsh_test_repo"
lsh sync

# ‚ùå Pulling .env (lsh_test_repo_lsh_test_repo) from IPFS...
# ‚ùå ERROR No secrets found for environment: lsh_test_repo_lsh_test_repo
```

Expected: `lsh_test_repo`
Actual: `lsh_test_repo_lsh_test_repo` (duplicated!)

### Root Cause

**Double transformation of environment name:**

```typescript
// v2.2.3 (Broken)
async smartSync(autoExecute = false): Promise<void> {
  // Line 691: Transform environment name
  const effectiveEnv = getRepoAwareEnvironment(environment);
  // effectiveEnv is now "lsh_test_repo"

  // Line 829: Pass already-transformed environment to pull()
  await this.pull(envFilePath, effectiveEnv, false); // ‚ùå Wrong!
}

async pull(filePath: string, environment: string, ...): Promise<void> {
  // Line 311: Transform AGAIN!
  const effectiveEnv = getRepoAwareEnvironment(environment);
  // "lsh_test_repo" -> "lsh_test_repo_lsh_test_repo" ‚ùå
}
```

**The Problem:**
1. `smartSync()` transforms `''` ‚Üí `'lsh_test_repo'` (correct)
2. `smartSync()` passes transformed `effectiveEnv` to `pull()` (wrong!)
3. `pull()` transforms again: `'lsh_test_repo'` ‚Üí `'lsh_test_repo_lsh_test_repo'` (broken!)

### The Solution (v2.2.4)

**Pass raw environment parameter to let pull() handle transformation:**

```typescript
// v2.2.4 (Fixed)
async smartSync(autoExecute = false): Promise<void> {
  const effectiveEnv = getRepoAwareEnvironment(environment);
  // effectiveEnv is "lsh_test_repo"

  // ‚úÖ Pass RAW environment, not effectiveEnv
  await this.pull(envFilePath, environment, false); // Use raw environment, not effectiveEnv
}

async pull(filePath: string, environment: string, ...): Promise<void> {
  // Transform once, correctly
  const effectiveEnv = getRepoAwareEnvironment(environment);
  // '' -> "lsh_test_repo" ‚úÖ (correct!)
}
```

### What This Fixes

**Complete Sync Workflow (v2.2.4):**
```bash
# In git repo "test_multihost"
export LSH_SECRETS_KEY=abc123...
lsh sync

# ‚úÖ Pulling .env (test_multihost) from IPFS...  ‚Üê Correct name!
# ‚úÖ Secrets synced successfully!
```

**Before v2.2.4:**
- ‚ùå Environment name duplicated: `repo_name_repo_name`
- ‚ùå Pull operations failed with "No secrets found"
- ‚ùå `lsh sync` completely broken

**After v2.2.4:**
- ‚úÖ Environment name correct: `repo_name`
- ‚úÖ Pull operations work as expected
- ‚úÖ `lsh sync` works correctly

## üìù Technical Details

### Files Changed

**`src/lib/secrets-manager.ts` (2 lines modified)**

**Line 829 (smartSync - auto pull):**
```diff
- await this.pull(envFilePath, effectiveEnv, false);
+ await this.pull(envFilePath, environment, false); // Use raw environment, not effectiveEnv
```

**Line 883 (smartSync - backup and pull):**
```diff
- await this.pull(envFilePath, effectiveEnv, false);
+ await this.pull(envFilePath, environment, false); // Use raw environment, not effectiveEnv
```

### Implementation Details

**Key Principle:** Each method should receive the RAW environment parameter and apply transformations internally. Passing pre-transformed values causes double transformation.

**Correct Pattern:**
```typescript
// ‚úÖ Good: Pass raw environment
async smartSync() {
  const effectiveEnv = getRepoAwareEnvironment(environment); // Transform for local use
  await this.pull(envFilePath, environment, false);         // Pass raw to other methods
}

// ‚ùå Bad: Pass transformed environment
async smartSync() {
  const effectiveEnv = getRepoAwareEnvironment(environment);
  await this.pull(envFilePath, effectiveEnv, false); // Will transform AGAIN!
}
```

**Why This Pattern:**
- Each method controls its own environment transformation
- No assumptions about whether input is raw or transformed
- Prevents cascading transformation bugs
- Matches existing pattern used in `push()` calls

### Transformation Flow (Fixed)

```
User Input: environment = "" (empty in root .env)
    ‚Üì
smartSync():
    effectiveEnv = getRepoAwareEnvironment("") = "lsh_test_repo"
    (local variable for display/logging only)
    ‚Üì
    Call: pull(envFilePath, "", false)  ‚Üê Pass RAW environment
    ‚Üì
pull():
    effectiveEnv = getRepoAwareEnvironment("") = "lsh_test_repo"  ‚úÖ Correct!
    ‚Üì
    metadata key = "lsh_test_repo_" ‚úÖ
    Query storage for "lsh_test_repo_" ‚úÖ
```

## üéØ Impact

### Before v2.2.4 (Broken)
```bash
cd ~/repos/lsh_test_repo
lsh sync

# ‚ùå Pulling .env (lsh_test_repo_lsh_test_repo) from IPFS...
# ‚ùå ERROR No secrets found for environment: lsh_test_repo_lsh_test_repo
# Result: FAILED
```

### After v2.2.4 (Fixed)
```bash
cd ~/repos/lsh_test_repo
lsh sync

# ‚úÖ Pulling .env (lsh_test_repo) from IPFS...
# ‚úÖ Secrets pulled from cloud!
# Result: SUCCESS
```

## üì¶ Installation

```bash
# Upgrade to v2.2.4
npm update -g lsh-framework@2.2.4

# Verify
lsh --version  # Should show 2.2.4
```

## üîÑ Migration from v2.2.3

**No migration required!**

1. Upgrade to v2.2.4
2. `lsh sync` will now work correctly
3. All existing secrets remain accessible

**If you encountered "No secrets found" errors in v2.2.3:**
- The error was due to incorrect environment name lookup
- Upgrading to v2.2.4 immediately fixes the issue
- No need to re-push or modify existing secrets

## ‚ö†Ô∏è Important Notes

### What Was Affected
- ‚úÖ `lsh sync` - Fixed (primary issue)
- ‚úÖ Multi-host pull operations - Fixed
- ‚úÖ Repo-aware environment naming - Fixed

### What Was NOT Affected
- ‚úÖ Direct `lsh push` commands - Already worked correctly
- ‚úÖ Direct `lsh pull` commands - Already worked correctly
- ‚úÖ Non-repo-aware environments - Already worked correctly

### Why push() Wasn't Affected
The `push()` method already used the correct pattern:
```typescript
// Line 773 in smartSync() - Already correct!
await this.push(envFilePath, environment, true);
```

This is why `lsh sync` could push successfully but failed on pull.

## üêõ Related Issues

This fixes a regression introduced during the v2.0 repo-aware environment naming implementation:
- **v2.0.0**: Introduced repo-aware environment naming
- **v2.2.3**: Bug - `smartSync()` incorrectly passes transformed environment to `pull()`
- **v2.2.4**: Fixed - `smartSync()` passes raw environment ‚Üê **This release**
- **v2.2.5**: Extended fix to `push()` method (see v2.2.5 release notes)

## üìä Test Results

**Build:** ‚úÖ Success
**Manual Test:** ‚úÖ Sync works correctly with repo-aware naming
**Regression Test:** ‚úÖ Non-repo-aware environments still work

**Test Scenario:**
```bash
# Test repo-aware naming
cd /tmp/lsh_test_repo
echo "SECRET_1=value1" > .env
export LSH_SECRETS_KEY=aaa...
lsh push
lsh sync
# ‚úÖ Result: Pulled .env (lsh_test_repo) - SUCCESS!

# Test non-repo-aware naming
lsh push --env production
lsh pull --env production
# ‚úÖ Result: Still works - no regression
```

## üìà Full Changelog

**From v2.2.3 ‚Üí v2.2.4:**

### Fixed
- Environment name duplication in `smartSync()` method
- `lsh sync` failing with "No secrets found" error
- Repo-aware environment naming in pull operations

### Changed
- `smartSync()` line 829: Use raw `environment` instead of `effectiveEnv` in pull call
- `smartSync()` line 883: Use raw `environment` instead of `effectiveEnv` in pull call
- Added comments clarifying the correct pattern

### Technical
- Aligned pull() calls with push() pattern (both use raw environment)
- Prevents double transformation of environment names
- Maintains single source of truth for environment transformation

**GitHub**: https://github.com/gwicho38/lsh/compare/v2.2.3...v2.2.4

---

**Critical fix for multi-host workflows!** üîß v2.2.4 ensures `lsh sync` works correctly with repo-aware environment naming.
