# Release Notes: v2.0.2

**Release Date:** 2024-11-24
**Type:** Hotfix - Critical Bug Fix

## üö® Critical Bug Fix

### Double Repo-Prefix in smartSync() (v2.0.0-v2.0.1)

**Issue**: The `smartSync()` command (used by `lsh sync`) was passing already-transformed environment names to `push()`, which then transformed them again, causing a double repo-prefix bug.

**User Evidence**:
```bash
lsh sync
‚¨ÜÔ∏è  Local .env exists but not in cloud
   Pushing to cloud...
2025-11-24T14:05:09.553Z INFO  [SecretsManager] Pushing .env to IPFS (lsh_test_repo_lsh_test_repo)...
                                                                        ‚Üë DOUBLE PREFIX!
```

**Root Cause**: Three calls to `push()` in `smartSync()` (lines 788, 809, 870) were passing the already-transformed `effectiveEnv` instead of the raw `environment` parameter:

```typescript
// v2.0.1 (Broken)
const effectiveEnv = this.getRepoAwareEnvironment(environment);  // Line 691: Transforms '' ‚Üí 'lsh_test_repo'
await this.push(envFilePath, effectiveEnv, force);               // Line 809: Passes 'lsh_test_repo'
// push() then transforms AGAIN: 'lsh_test_repo' ‚Üí 'lsh_test_repo_lsh_test_repo' ‚ùå
```

**Fix**: Changed lines 788, 809, and 870 to pass the raw `environment` parameter (matching the pattern on line 752):

```typescript
// v2.0.2 (Fixed)
const effectiveEnv = this.getRepoAwareEnvironment(environment);  // Line 691: Transforms '' ‚Üí 'lsh_test_repo'
await this.push(envFilePath, environment, force);                // Line 809: Passes '' (raw)
// push() transforms once: '' ‚Üí 'lsh_test_repo' ‚úÖ
```

## üéØ What This Fixes

### Before (v2.0.0-v2.0.1 - Broken)
```bash
cd lsh_test_repo
lsh sync                    # Pushed to: lsh_test_repo_lsh_test_repo ‚ùå
lsh pull                    # Looking for: lsh_test_repo
‚ùå No secrets found          # Mismatch!
```

### After (v2.0.2 - Fixed)
```bash
cd lsh_test_repo
lsh sync                    # Pushes to: lsh_test_repo ‚úÖ
lsh pull                    # Pulls from: lsh_test_repo ‚úÖ
```

## üìù Technical Details

**Lines Changed** in `src/lib/secrets-manager.ts`:
- Line 788: `await this.push(envFilePath, environment, force);` (was `effectiveEnv`)
- Line 809: `await this.push(envFilePath, environment, force);` (was `effectiveEnv`)
- Line 870: `await this.push(envFilePath, environment, force);` (was `effectiveEnv`)

**Why This Happened**:
- v2.0.1 fixed `push()` to transform environment internally
- But `smartSync()` had 3 calls that passed already-transformed values
- Only line 752 was correct (with a comment explaining why)
- The other 3 calls needed the same fix

## üì¶ Installation

```bash
# Upgrade from v2.0.0 or v2.0.1
npm update -g lsh-framework@2.0.2

# Verify
lsh --version  # Should show 2.0.2
```

## ‚ö†Ô∏è For v2.0.0-v2.0.1 Users

If you used `lsh sync` with v2.0.0 or v2.0.1, your secrets may have been stored with a double repo-prefix. To fix:

```bash
# Update first
npm update -g lsh-framework@2.0.2

# Re-push to correct location
lsh sync  # This will now push to the correct environment
```

## üîß Multi-Host Sync Note

**Important Discovery**: LSH's IPFS storage currently only stores secrets locally in `~/.lsh/secrets-cache/`. For actual multi-host sync, you need to either:

1. **Configure Supabase** (already supported):
   ```bash
   lsh supabase init
   ```

2. **Wait for Storacha/IPFS network integration** (planned):
   - Dependency is already installed (`@storacha/client`)
   - Implementation is TODO (see `src/lib/ipfs-secrets-storage.ts:96-97`)

The local IPFS storage is content-addressed and uses IPFS-compatible CIDs, but doesn't actually sync to a network without Supabase or future Storacha integration.

## üìä Related Issues

- Issue #98: Pre-existing lint errors (537 errors to clean up)
- v2.0.1 fix: Empty environment not transformed in `push()`
- v2.0.0 feature: Simplified environment naming

**Full Changelog**: https://github.com/gwicho38/lsh/compare/v2.0.1...v2.0.2

---

**Thank you for your patience!** This completes the v2.0 migration bug fixes. Multi-host sync will work correctly once you configure Supabase or when Storacha integration is implemented.
