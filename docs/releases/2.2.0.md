# Release Notes: v2.2.0

**Release Date:** 2024-11-24
**Type:** Minor Release - Smart Multi-Host Setup

## üéâ Major Feature: Smart Repo Detection in Init Wizard

### The Problem Before v2.2.0

When setting up LSH on multiple machines, each `lsh init` would generate a **new** encryption key, causing secrets to be encrypted differently on each host:

```bash
# Host A
lsh init
# Generated key: abc123...

# Host B
lsh init
# Generated key: xyz789...  ‚ùå Different key!

# Result: Can't sync! üòû
```

Users had to manually copy the encryption key from Host A to Host B, which was error-prone.

### The Solution in v2.2.0

**Smart repo detection!** `lsh init` now automatically detects if secrets already exist for the current repo and prompts for the existing encryption key instead of generating a new one.

```bash
# Host A (first time)
cd ~/repos/my-project
lsh init
# No existing secrets found
# ‚úÖ Generating new encryption key...
# ‚úÖ Pushed secrets to cloud

# Host B (second machine) - THE MAGIC! ‚ú®
cd ~/repos/my-project
lsh init
# ‚ú® Found existing secrets for "my-project" in cloud!
# ? Pull existing secrets from another machine? (Y/n)
# ? Enter the encryption key from your other machine: ****
# ‚úÖ Pulling secrets from cloud...
# ‚úÖ Setup complete!
```

**One command, fully synced!** üéâ

## üöÄ How It Works

### Detection Logic

When you run `lsh init` in a git repo, it:

1. **Checks** if secrets already exist in the cloud for this repo name
2. **If yes** ‚Üí Prompts to enter existing encryption key
3. **If no** ‚Üí Generates new encryption key (new project)

### The Smart Flow

**New Project (no existing secrets):**
```bash
cd ~/repos/brand-new-project
lsh init

üîê LSH Secrets Manager - Setup Wizard
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

? Choose storage backend: Storacha (IPFS network)
? Enter your email: you@example.com

‚ú® Setup complete!
üìù Your encryption key: abc123...
    Share this key with your team!
```

**Existing Project (secrets found):**
```bash
cd ~/repos/existing-project
lsh init

üîê LSH Secrets Manager - Setup Wizard
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚ú® Found existing secrets for "existing-project" in cloud!
This appears to be an existing project.

? Pull existing secrets from another machine? Yes
? Enter the encryption key from your other machine: ****

? Choose storage backend: Storacha (IPFS network)
? Enter your email: you@example.com

? Pull secrets now? Yes
‚úÖ Pulling secrets from cloud...
‚úÖ Secrets pulled successfully!

‚ú® Setup complete!
```

## üìã User Scenarios

### Scenario 1: Setting Up Second Machine

**Before v2.2.0:**
```bash
# Host A
lsh init
# Key: abc123...
lsh push

# Host B - Manual steps
lsh init
# Key: xyz789... ‚ùå wrong key!
nano .env
# Manually paste: LSH_SECRETS_KEY=abc123...
lsh pull
```

**After v2.2.0:**
```bash
# Host A
lsh init
lsh push

# Host B - Automatic! ‚ú®
lsh init
# Detected existing secrets
# Prompted for key
# Auto-pulled secrets
# Done! ‚úÖ
```

### Scenario 2: New Team Member Onboarding

**Before v2.2.0:**
```
1. Clone repo
2. Install LSH
3. Get encryption key from team lead (Slack/email)
4. Create .env manually
5. Add encryption key
6. Run lsh pull
```

**After v2.2.0:**
```
1. Clone repo
2. Run: lsh init
   - Auto-detects existing project
   - Prompts for key from team lead
   - Auto-pulls all secrets
3. Done! ‚úÖ
```

### Scenario 3: Accidentally Generated New Key

If you say "No" to using existing secrets:

```bash
lsh init

‚ú® Found existing secrets for "my-project" in cloud!

? Pull existing secrets from another machine? No

‚ö†Ô∏è  Generating new key will overwrite existing secrets!

# Proceeds with new key (overwrites old secrets)
```

## üîß Technical Details

### New Functions

**`checkCloudSecretsExist()`**
- Checks if secrets-metadata.json contains entries for current repo
- Returns `{ exists: boolean, repoName?: string, environment?: string }`
- Uses `getGitRepoInfo()` to determine current repo name

**`pullSecretsAfterInit()`**
- Automatically pulls secrets after init completes
- Handles errors gracefully with helpful messages
- Uses new encryption key from user input

### Modified Functions

**`runSetupWizard()`**
- Now calls `checkCloudSecretsExist()` before generating key
- Conditionally prompts for existing key or generates new one
- Offers to pull secrets immediately after configuration

### Files Changed

- `src/commands/init.ts` (+100 lines)
  - Added smart detection logic
  - Added existing key prompt
  - Added auto-pull after init

### Key Validation

The existing key prompt validates:
- ‚úÖ Not empty
- ‚úÖ Exactly 64 characters (32 bytes hex)
- ‚úÖ Hexadecimal format only

```typescript
validate: (input) => {
  if (!input.trim()) return 'Encryption key is required';
  if (input.length !== 64) return 'Key should be 64 characters';
  if (!/^[0-9a-f]+$/i.test(input)) return 'Key should be hexadecimal';
  return true;
}
```

## üéØ Benefits

### For Individual Users
- ‚úÖ **No manual key copying** between machines
- ‚úÖ **Automatic sync** on init
- ‚úÖ **Fewer steps** to get started on new machine

### For Teams
- ‚úÖ **Easier onboarding** for new team members
- ‚úÖ **Reduced errors** from wrong encryption keys
- ‚úÖ **Better DX** (developer experience)

### For Everyone
- ‚úÖ **Smarter defaults** - does the right thing automatically
- ‚úÖ **Clear messaging** - tells you what it found
- ‚úÖ **Safe** - warns before overwriting

## üìä Comparison

| Action | v2.1.2 (Before) | v2.2.0 (After) |
|--------|-----------------|----------------|
| **New project** | Generate key ‚úÖ | Generate key ‚úÖ |
| **Existing project** | Generate new key ‚ùå | Prompt for existing key ‚úÖ |
| **Team onboarding** | 6 manual steps | 1 command (`lsh init`) |
| **Error prone** | High | Low |
| **User has to know** | "Copy key manually" | Nothing! Auto-detected |

## üì¶ Installation

```bash
# Upgrade from any version
npm update -g lsh-framework@2.2.0

# Verify
lsh --version  # Should show 2.2.0
```

## üß™ Testing the Feature

### Test Scenario: Multi-Host Setup

**Host A:**
```bash
mkdir -p /tmp/test-repo-a && cd /tmp/test-repo-a
git init
echo "test" > README.md
git add . && git commit -m "init"

lsh init --storacha
# Follow prompts, note the generated key

echo "SECRET=value123" > .env
lsh push
```

**Host B:**
```bash
mkdir -p /tmp/test-repo-a && cd /tmp/test-repo-a
git init
echo "test" > README.md
git add . && git commit -m "init"

lsh init --storacha
# ‚ú® Should detect existing secrets!
# Should prompt for key
# Should auto-pull after setup
```

## ‚ö†Ô∏è  Important Notes

### When Detection Works
- ‚úÖ You're in a **git repository**
- ‚úÖ Repo name matches existing secrets
- ‚úÖ Metadata file exists (from previous push)

### When Detection Doesn't Work
- ‚ùå Not in a git repo (generates new key)
- ‚ùå Different repo name than remote
- ‚ùå No previous push from any machine

### Edge Cases Handled
- **No git repo**: Falls back to generating new key
- **User says No**: Warns and generates new key (overwrites)
- **Pull fails**: Shows helpful error, can retry manually
- **Wrong key**: Pull will fail with decryption error (user can try again)

## üîÆ Future Enhancements

- Check Storacha network directly (not just local metadata)
- Support key exchange via QR code for mobile
- Team workspace with automatic key distribution
- Validate key by attempting small decrypt before full pull

## üìà Full Changelog

**From v2.1.2 ‚Üí v2.2.0:**

### Added
- Smart repo detection in `lsh init`
- Automatic check for existing secrets in cloud
- Prompt for existing encryption key on second+ machine
- Auto-pull secrets after init (optional)
- Key validation (length, format)
- Warning when overwriting existing secrets

### Changed
- `lsh init` workflow now context-aware
- Encryption key generation is conditional (not automatic)

### Technical
- New `checkCloudSecretsExist()` function
- New `pullSecretsAfterInit()` helper
- Enhanced `runSetupWizard()` with detection logic

**GitHub**: https://github.com/gwicho38/lsh/compare/v2.1.2...v2.2.0

---

**Game-changer for multi-host workflows!** üöÄ Upgrade now for the smartest init experience yet.
