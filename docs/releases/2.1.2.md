# Release Notes: v2.1.2

**Release Date:** 2024-11-24
**Type:** Patch Release - Critical Bug Fix

## üö® Critical Bug Fix: Pull Command Environment Name

### Issue

The `lsh pull` command was not correctly transforming environment names when using repo-aware naming, causing pull operations to fail with "No secrets found for environment:" (empty environment name).

This was the **same bug pattern** as v2.0.2's `smartSync()` fix, but affecting the `pull()` method.

### User Evidence

```bash
# Host B
cd ~/lsh_test_repo
lsh pull

# Error (v2.1.1):
‚ùå No secrets found for environment:   ‚Üê Empty!

# Fixed (v2.1.2):
‚úÖ Pulling .env (lsh_test_repo) from IPFS...  ‚Üê Correct!
```

### Root Cause

The `pull()` method in `src/lib/secrets-manager.ts` was passing the **raw** environment parameter to storage instead of the **transformed** (repo-aware) environment name.

```typescript
// v2.1.1 (Broken)
const secrets = await this.storage.pull(
  environment,  // ‚ùå Raw: "" or "dev"
  this.encryptionKey,
  this.gitInfo?.repoName
);

// v2.1.2 (Fixed)
const effectiveEnv = this.getRepoAwareEnvironment(environment);
const secrets = await this.storage.pull(
  effectiveEnv,  // ‚úÖ Transformed: "lsh_test_repo" or "lsh_test_repo_dev"
  this.encryptionKey,
  this.gitInfo?.repoName
);
```

### What This Fixes

**Multi-Host Sync Scenario:**

```bash
# Host A (Mac) - Push secrets
cd ~/repos/my-project
lsh push --env dev
# ‚úÖ Stored as: my-project_dev

# Host B (Linux) - Pull secrets
cd ~/my-project
lsh pull --env dev

# Before v2.1.2:
‚ùå Looking for: "" (empty)
‚ùå Error: No secrets found

# After v2.1.2:
‚úÖ Looking for: my-project_dev
‚úÖ Successfully pulled secrets!
```

## üìù Technical Details

**File Changed:**
- `src/lib/secrets-manager.ts` (lines 311-322)

**Changes:**
1. Added `effectiveEnv` calculation at start of `pull()` method
2. Changed `storage.pull()` call to use `effectiveEnv` instead of `environment`
3. Removed duplicate `getRepoAwareEnvironment()` call in error message
4. Updated log message to use pre-calculated `effectiveEnv`

**Lines Modified:**
```diff
  async pull(envFilePath: string = '.env', environment: string = 'dev', force: boolean = false): Promise<void> {
    // ... validation ...

+   const effectiveEnv = this.getRepoAwareEnvironment(environment);
-   logger.info(`Pulling ${filename} (${this.getRepoAwareEnvironment(environment)}) from IPFS...`);
+   logger.info(`Pulling ${filename} (${effectiveEnv}) from IPFS...`);

    // Get secrets from IPFS storage
    const secrets = await this.storage.pull(
-     environment,
+     effectiveEnv,
      this.encryptionKey,
      this.gitInfo?.repoName
    );

    if (secrets.length === 0) {
-     const effectiveEnv = this.getRepoAwareEnvironment(environment);
      throw new Error(`No secrets found for environment: ${effectiveEnv}\n\n` +
```

## üéØ Impact

### Before v2.1.2 (Broken)
```bash
# Any pull operation in a git repo would fail
cd ~/repos/my-app
lsh pull
# ‚ùå Error: No secrets found for environment:

# Even with explicit environment
lsh pull --env dev
# ‚ùå Error: No secrets found for environment:
```

### After v2.1.2 (Fixed)
```bash
# Pull now works correctly
cd ~/repos/my-app
lsh pull
# ‚úÖ Pulling .env (my-app) from IPFS...
# ‚úÖ Pulled 10 secrets

lsh pull --env dev
# ‚úÖ Pulling .env (my-app_dev) from IPFS...
# ‚úÖ Pulled 10 secrets
```

## üì¶ Installation

```bash
# Upgrade from v2.1.0 or v2.1.1
npm update -g lsh-framework@2.1.2

# Verify
lsh --version  # Should show 2.1.2
```

## üîÑ Migration from v2.1.1

**No migration required!** This is a bug fix that restores correct behavior.

If you experienced pull failures in v2.1.1, they should now work correctly in v2.1.2.

## ‚ö†Ô∏è Important Notes

### Multi-Host Sync Requirements

For successful multi-host sync, both hosts must:

1. ‚úÖ **Use the same encryption key** (`LSH_SECRETS_KEY`)
2. ‚úÖ **Be in repos with the same name** (or use explicit `--env`)
3. ‚úÖ **Have Storacha authenticated** (if using network sync)

**Example:**
```bash
# Host A
cd ~/repos/my-project
export LSH_SECRETS_KEY=abc123...
lsh push --env dev

# Host B (must match!)
cd ~/repos/my-project                    # ‚úÖ Same repo name
export LSH_SECRETS_KEY=abc123...         # ‚úÖ Same encryption key
lsh storacha login [email protected]  # ‚úÖ Authenticated
lsh pull --env dev                       # ‚úÖ Now works!
```

### Common Errors After Fix

If you still get errors after upgrading to v2.1.2:

**Error: "bad decrypt"**
```bash
‚ùå Failed to pull secrets: error:1C800064:Provider routines::bad decrypt
```
**Cause:** Encryption keys don't match between push and pull.
**Solution:** Ensure both hosts use the same `LSH_SECRETS_KEY`.

**Error: "No secrets found"**
```bash
‚ùå No secrets found for environment: my-project_dev
```
**Cause:** Secrets haven't been pushed yet, or were pushed with different repo name.
**Solution:**
- Check: `lsh env` to see available environments
- Or push first: `lsh push --env dev`

## üêõ Related Issues

This bug fix is part of the ongoing v2.0 environment naming improvements:
- **v2.0.0**: Introduced simplified repo-aware environment naming
- **v2.0.1**: Fixed `push()` to transform environment internally
- **v2.0.2**: Fixed `smartSync()` to pass raw environment to `push()`
- **v2.1.2**: Fixed `pull()` to use transformed environment ‚Üê **This release**

All environment transformation inconsistencies should now be resolved.

## üìä Test Results

**Build:** ‚úÖ Success
**Storacha Tests:** 11/12 passed (1 timeout, unrelated to fix)
**Full Test Suite:** 472/505 passed

## üîÆ Future Work

- Add integration test specifically for multi-host pull scenario
- Improve error messages to suggest checking encryption key match
- Add `lsh doctor` check for encryption key consistency

## üìà Full Changelog

**From v2.1.1 ‚Üí v2.1.2:**

### Fixed
- `lsh pull` now correctly uses transformed environment name (repo-aware)
- Multi-host sync pull operations now work as expected
- Environment name is no longer empty in error messages

### Technical
- `SecretsManager.pull()` now calculates `effectiveEnv` at start of method
- Removed duplicate `getRepoAwareEnvironment()` call
- Consistent environment transformation across push/pull/sync

**GitHub**: https://github.com/gwicho38/lsh/compare/v2.1.1...v2.1.2

---

**Critical fix for multi-host sync!** üîß Upgrade immediately if experiencing pull failures.
