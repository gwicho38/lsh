# LSH v1.1.0 - Batch Upsert Secrets

**Release Date:** 2025-11-06

## ðŸŽ‰ New Feature: Batch Upsert from stdin

You can now pipe environment variables directly into your `.env` file using `lsh set`!

## What's New

### Batch Upsert via Pipe/stdin

The `lsh set` command now accepts input from stdin, allowing you to batch upsert environment variables:

```bash
# Copy all environment variables to .env
printenv | lsh set

# Import from another .env file
cat .env.backup | lsh set

# Import specific variables (AWS credentials)
printenv | grep "^AWS_" | lsh set

# Merge multiple sources
cat .env.base .env.local | lsh set

# From file with --stdin flag
lsh set --stdin < .env.production
```

### How It Works

**Input Format:** KEY=VALUE pairs (one per line)
```
DATABASE_URL=postgres://localhost/db
API_KEY=sk_test_12345
REDIS_URL=redis://localhost:6379
```

**Features:**
- âœ… **Automatic Upsert** - Updates existing keys, adds new ones
- âœ… **Preserves Comments** - Keeps your file structure intact
- âœ… **Handles Quotes** - Automatically handles quoted values
- âœ… **Validates Keys** - Ensures valid environment variable names
- âœ… **Shows Summary** - Reports what was added/updated
- âœ… **Skips Invalid** - Continues on errors, reports at end

### Usage Examples

#### Copy Current Environment
```bash
# Save all current environment variables
printenv | lsh set
```

**Output:**
```
âœ… Batch upsert complete:
   Added: 47 key(s)
```

#### Import from Backup
```bash
# Restore from backup file
cat .env.backup | lsh set
```

**Output:**
```
âœ… Batch upsert complete:
   Added: 5 key(s)
   Updated: 12 key(s)
```

#### Selective Import
```bash
# Import only AWS credentials
printenv | grep "^AWS_" | lsh set

# Import database configs
cat .env.production | grep "^DB_" | lsh set
```

#### Merge Multiple Sources
```bash
# Base config + environment-specific overrides
cat .env.base .env.local | lsh set
```

#### With Error Handling
```bash
# Example with invalid entries
echo -e "VALID_KEY=value\nINVALID-KEY=bad\nANOTHER_KEY=good" | lsh set
```

**Output:**
```
âœ… Batch upsert complete:
   Added: 2 key(s)

âš ï¸  Skipped invalid entries:
   Invalid key format: INVALID-KEY
```

### Backward Compatibility

The single key-value syntax still works exactly as before:

```bash
# Set individual values (unchanged)
lsh set API_KEY sk_live_12345
lsh set DATABASE_URL postgres://localhost/db
```

### Command Signature

```bash
# Before (v1.0.x)
lsh set <key> <value>

# After (v1.1.0)
lsh set [key] [value]          # Single mode
lsh set                         # Batch mode (from pipe)
lsh set --stdin < file.env     # Batch mode (explicit)
```

## Updated Commands

| Command | Description |
|---------|-------------|
| `lsh set <key> <value>` | Set a single secret value |
| `printenv \| lsh set` | Batch upsert from stdin (pipe) |
| `lsh set --stdin < file` | Batch upsert from file |
| `cat file \| lsh set` | Import from another .env file |

## Use Cases

### 1. Migrate from .env.example
```bash
cat .env.example | lsh set
# Then manually update sensitive values
lsh set DATABASE_PASSWORD actual_password
lsh set API_KEY real_api_key
```

### 2. Copy Production to Staging
```bash
# On production server
lsh pull --env prod
printenv | lsh set --file .env.staging
lsh push --file .env.staging --env staging
```

### 3. Backup Current Environment
```bash
# Save current state
printenv > backup-$(date +%Y%m%d).env

# Restore later
cat backup-20251106.env | lsh set
```

### 4. Docker Container Environment
```bash
# Inside container, save environment to host
docker exec mycontainer printenv > container.env
cat container.env | lsh set
```

### 5. CI/CD Environment Variables
```bash
# Export from GitHub Actions / GitLab CI
env | grep "^CI_" | lsh set
```

## Implementation Details

### File Changes
- **`src/services/secrets/secrets.ts`** - Added batch upsert functionality
  - Modified `set` command to accept optional arguments
  - Added `batchSetSecrets()` function for stdin processing
  - Added `setSingleSecret()` helper function
  - Detects TTY vs piped input
  - Validates KEY=VALUE format
  - Preserves file structure and comments

### Algorithm

1. **Detect Input Source**
   - Check if arguments provided (single mode)
   - Check if stdin is TTY (error)
   - Read from stdin (batch mode)

2. **Parse Input**
   - Split lines
   - Skip comments and empty lines
   - Parse KEY=VALUE format
   - Validate key names
   - Handle quoted values

3. **Upsert Logic**
   - Read existing .env file
   - Track existing keys
   - Update matching keys in-place
   - Append new keys at end
   - Preserve comments and structure

4. **Report Results**
   - Count added keys
   - Count updated keys
   - List validation errors

## Testing

All test cases pass:

âœ… Single key-value (backward compatible)
âœ… Batch upsert from echo
âœ… Batch upsert from printenv
âœ… Update existing keys
âœ… Add new keys
âœ… Preserve comments
âœ… Handle quoted values
âœ… Validate key names
âœ… Error handling

## Documentation Updates

- âœ… Updated README.md with batch upsert examples
- âœ… Added to Secrets Commands table
- âœ… Updated `lsh set --help` description

## Migration Guide

No migration needed! This is a backward-compatible enhancement.

**Before (still works):**
```bash
lsh set DATABASE_URL postgres://localhost/db
```

**New capability:**
```bash
printenv | lsh set
```

## Examples

### Simple Pipe
```bash
echo -e "FOO=bar\nBAZ=qux" | lsh set
```

### From File
```bash
cat .env.backup | lsh set
```

### Filtered Variables
```bash
printenv | grep "^NODE_" | lsh set
```

### Multiple Files
```bash
cat .env.base .env.local | lsh set
```

## Future Enhancements

Potential improvements for future versions:

- [ ] `--dry-run` flag to preview changes
- [ ] `--merge` vs `--replace` modes
- [ ] JSON input format support
- [ ] Export to different formats (YAML, JSON)
- [ ] Diff preview before upsert

## Changelog

### Added
- Batch upsert from stdin via `printenv | lsh set`
- `--stdin` flag for explicit stdin mode
- Validation for KEY=VALUE format
- Summary reporting (added/updated counts)
- Error collection for invalid entries

### Changed
- `set` command arguments now optional: `[key] [value]`
- Enhanced help text with pipe examples

### Fixed
- N/A (new feature)

---

**Full Changelog**: https://github.com/gwicho38/lsh/compare/v1.0.0...v1.1.0
