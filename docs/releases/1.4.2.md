# Release Notes: v1.4.2

**Release Date:** November 20, 2025

## üêõ Bug Fixes

This is a bugfix release addressing a critical issue where `lsh sync` (and other secrets commands) would hang indefinitely when using local storage.

## What's Fixed

### lsh sync Hanging with Local Storage

**Issue:** When running `lsh sync`, `lsh push`, or `lsh pull` with local storage fallback (no Supabase configured), the commands would complete successfully but hang instead of exiting, requiring users to press Ctrl+C to terminate the process.

**Root Cause:** The `LocalStorageAdapter` starts a `setInterval` timer for auto-flushing data every 5 seconds to disk. This timer keeps the Node.js event loop alive, preventing the process from exiting naturally after commands complete.

**Fix:** Added cleanup mechanism to properly clear timers and allow process to exit:

```typescript
// Before: Commands would complete but hang
$ lsh sync
‚úÖ Secrets pushed to cloud!

[hangs here - requires Ctrl+C]

// After: Commands exit cleanly
$ lsh sync
‚úÖ Secrets pushed to cloud!
$
```

## Technical Changes

### New Methods

**`SecretsManager.cleanup()`**
- Cleans up resources and stops timers
- Called automatically in finally blocks of all command handlers

**`DatabasePersistence.cleanup()`**
- Delegates cleanup to underlying storage adapter
- Safe to call multiple times

**`LocalStorageAdapter.cleanup()`**
- Clears the auto-flush interval timer
- Already existed, now properly utilized

### Updated Command Handlers

All secrets command handlers now properly clean up:

```typescript
// src/services/secrets/secrets.ts
.action(async (options) => {
  const manager = new SecretsManager();
  try {
    await manager.push(options.file, options.env, options.force);
  } catch (error) {
    await manager.cleanup();
    process.exit(1);
  } finally {
    await manager.cleanup();  // ‚úÖ Ensures clean exit
  }
});
```

Updated commands:
- `lsh push` - Properly exits after pushing secrets
- `lsh pull` - Properly exits after pulling secrets
- `lsh sync` - Properly exits after syncing secrets

## Repository Organization Improvements

This release also includes the repository reorganization from the previous commit:

### Cleaned Up Top-Level Directory

Reduced top-level files from 65 to 7 essential files for better maintainability:

**Essential Files:**
- README.md, package.json, package-lock.json
- tsconfig.json, jest.config.js, eslint.config.js
- CLAUDE.md

**Organized Directories:**
- `config/` - Configuration files (babel.config.js, fly.toml, etc.)
- `docs/` - All documentation properly categorized
  - `docs/development/` - Development documentation
  - `docs/features/` - Feature documentation
  - `docs/examples/` - Demo and test files
  - `docs/releases/` - Release notes
- `scripts/` - Build and utility scripts
  - `scripts/dev/` - Development utilities
- `resources/` - Dashboards and test data
  - `resources/dashboards/` - HTML dashboards
  - `resources/test-data/` - Webhook test data

### Updated Path References

All references to moved files updated:
- `Dockerfile` - fly.toml ‚Üí config/fly.toml
- `scripts/deploy.sh` - Updated config file path checks
- `docs/deployment/DEPLOYMENT.md` - Updated all fly.toml references

## Verification

- ‚úÖ All 451 tests passing
- ‚úÖ Build succeeds
- ‚úÖ CI/CD pipeline passing
- ‚úÖ Process exits cleanly after all secrets commands
- ‚úÖ No breaking changes

## Impact

### Who Should Upgrade?

**Essential for users experiencing:**
- `lsh sync` hanging after completion
- Need to Ctrl+C after secrets commands
- Running lsh in scripts or automation

**Recommended for all users:**
- Cleaner repository structure
- Better documentation organization
- Improved maintainability

## Upgrade

```bash
npm install -g lsh-framework@1.4.2
# or
npm update -g lsh-framework
```

## Testing the Fix

Before (v1.4.1 and earlier):
```bash
$ lsh sync
‚ö†Ô∏è  Supabase not configured - using local storage fallback
‚úÖ Secrets pushed to cloud!

[hangs - requires Ctrl+C]
^C
```

After (v1.4.2):
```bash
$ lsh sync
‚ö†Ô∏è  Supabase not configured - using local storage fallback
‚úÖ Secrets pushed to cloud!
$
```

## Breaking Changes

None. Fully backward compatible with v1.4.0 and v1.4.1.

## Files Changed

**Bug Fix:**
- `src/lib/secrets-manager.ts` - Added cleanup() method
- `src/lib/database-persistence.ts` - Added cleanup() method
- `src/services/secrets/secrets.ts` - Updated command handlers to call cleanup()

**Repository Organization:**
- 45 files moved to organized directories
- 3 path references updated
- No code logic changed

## Related

- v1.4.0 - Multi-tier storage and config system
- v1.4.1 - Database configuration documentation
- Issue report: "lsh sync now just hangs in the terminal"

---

**Diff from v1.4.1:** https://github.com/gwicho38/lsh/compare/v1.4.1...v1.4.2
