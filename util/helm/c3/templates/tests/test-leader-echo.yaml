apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-leader-echo"
  annotations:
    "helm.sh/hook": test
spec:
  restartPolicy: Never
  containers:
    - name: {{ .Release.Name }}-leader-echo
      image: '{{ .Values.c3.image.registry }}/{{ .Values.c3.image.repository }}:{{ .Values.c3.image.tag}}'
      imagePullPolicy: '{{ .Values.c3.image.pullPolicy }}'
      command:
        - /bin/bash
        - -ec
        - |
          echo "connecting to http://{{ .Values.c3.leader.service.name }}.{{ .Release.Namespace }}:{{ .Values.c3.leader.service.apiPort }} ..."
          http_response_code=$(curl -sv http://{{ .Values.c3.leader.service.name }}.{{ .Release.Namespace }}:{{ .Values.c3.leader.service.apiPort }}/api/8/Echo/echoStatic 2>&1 | grep "< HTTP/1.1" | awk '{print $3}')
          echo "response code ${http_response_code}"
          echo "connecting to http://{{ .Values.c3.leader.service.name }}.{{ .Release.Namespace }}:{{ .Values.c3.leader.service.api2Port }} ..."
          http_response_code2=$(curl -sv http://{{ .Values.c3.leader.service.name }}.{{ .Release.Namespace }}:{{ .Values.c3.leader.service.api2Port }}/api/8/Echo/echoStatic 2>&1 | grep "< HTTP/1.1" | awk '{print $3}')
          echo "response code ${http_response_code2}"
          [[ ${http_response_code} == 200 && ${http_response_code2} == 200 ]] && exit 0 || exit 1
