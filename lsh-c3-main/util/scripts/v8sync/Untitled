const axios = require('axios');
const AsyncLock = require('async-lock');

const semaphore = new AsyncLock();

const URL = 'https://gkev8c3apps.c3-e.com/cor1556/c3';
const AUTH_TOKEN =
  'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzUxMiJ9.eyJhcHAiOiJna2V2OGMzYXBwcy1jb3IxNTU2LWMzIiwiaXNzIjoiYzMuYWkiLCJncm91cHMiOlsiQzMuRW52QWRtaW4iXSwic2lkIjoxLCJhdWQiOiJjMy5haSIsImlkcCI6IiIsImMzZ3JvdXBzIjpbIkMzLkVudkFkbWluIl0sImlkcGdyb3VwcyI6IntcIk9pZGNJZHBDb25maWc6OmdrZXY4YzNhcHBzLmMzLWUuY29tXCI6W1wiZ2tldjhjM2FwcHMuYzMtZS5jb20vQzMuU3R1ZGlvVXNlclwiXX0iLCJzc2lkeCI6IiIsIm5hbWUiOiIzMWNmNGZlZThjYWExYTZlMzAxYmQ3OTNkNTUzODUzYmM2NzYxM2RkY2Q5MjJiNWNkNTg1NzIwZDMyN2U2ZjEzIiwiYWN0aW9uaWQiOiI3Mjg1Ljc5MzI3MSIsImlkIjoiMzFjZjRmZWU4Y2FhMWE2ZTMwMWJkNzkzZDU1Mzg1M2JjNjc2MTNkZGNkOTIyYjVjZDU4NTcyMGQzMjdlNmYxMyIsImV4cCI6MTcxOTYwNjA5NDAwMCwiZW1haWwiOiJsdWlzLmZlcm5hbmRlei1kZS1sYS12YXJhQGMzLmFpIn0.LsLD08MoEA6Tk2MFgfu_A_ZM6WB4CsFLlPl96z0qGiIobYXuthWerWXOWXM6qziny9EVNUAU_ehl6Sm1DQGSvJVmWKud5mYvYNG6FJcO64knLBrf22OE9a-hhuGVrywMvozEY-WrNbF5iBvdvJnqjuZJJeEZwcBqJi99XxDwkJIB5iA583-rGOWpPRNGArqQW29qgEST3SZv4TrGVdh9TMuREOb8pv0S9zJZpTAIWq5rtn-TrwCU3DyP4UIMYAMGaUO8sssSrYQS4XwZ8H8-2vonddxZKIBGKxKfVk8WKp770PvmnvR8kOCFyps-gGHn0nhlKW_NuX9U_M7kYtGLTw';

const c3FunctionCall = async (typeName, method, data, onSuccess) => {
  const url = `${URL}/api/8/${typeName}/${method}`;

  // Prevent parallel writes/deletions
  return semaphore.acquire('request', async (done) => {
    try {
      const response = await axios.post(url, data, {
        headers: {
          Authorization: AUTH_TOKEN,
        },
      });
      onSuccess?.(response.data);
    } catch (error) {
      console.error(error);
    } finally {
      done();
    }
  });
};

await c3FunctionCall('Pkg', 'appMode', {}, (x: any) => console.log(x));
