<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CI/CD Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #2d3748;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1.2rem;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .analytics-card {
            background: rgba(26, 32, 44, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #2d3748;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .analytics-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: #4a5568;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #f7fafc;
        }

        .card-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success { background: #48bb78; color: #1a202c; }
        .badge-warning { background: #ed8936; color: #1a202c; }
        .badge-danger { background: #f56565; color: #1a202c; }
        .badge-info { background: #4299e1; color: #1a202c; }

        .metric-value {
            font-size: 3rem;
            font-weight: 700;
            color: #f7fafc;
            margin-bottom: 10px;
        }

        .metric-label {
            color: #a0aec0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-change {
            font-size: 1rem;
            margin-top: 10px;
        }

        .change-positive { color: #48bb78; }
        .change-negative { color: #f56565; }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .insights-list {
            list-style: none;
            padding: 0;
        }

        .insight-item {
            background: rgba(45, 55, 72, 0.5);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #4299e1;
            transition: all 0.3s ease;
        }

        .insight-item.improvement {
            border-left-color: #48bb78;
        }

        .insight-item.degradation {
            border-left-color: #f56565;
        }

        .insight-item:hover {
            background: rgba(45, 55, 72, 0.8);
            transform: translateX(5px);
        }

        .anomaly-list {
            display: grid;
            gap: 15px;
        }

        .anomaly-item {
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid #f56565;
            padding: 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .anomaly-item.warning {
            background: rgba(237, 137, 54, 0.1);
            border-color: #ed8936;
        }

        .anomaly-item:hover {
            transform: scale(1.02);
        }

        .prediction-card {
            background: linear-gradient(135deg, rgba(66, 153, 225, 0.1), rgba(102, 126, 234, 0.1));
            border: 1px solid #4299e1;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .cost-breakdown {
            display: grid;
            gap: 15px;
        }

        .cost-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #2d3748;
        }

        .savings-list {
            list-style: none;
            padding: 0;
        }

        .savings-item {
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid #48bb78;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .savings-item::before {
            content: 'ðŸ’¡';
            margin-right: 8px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #2d3748;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .period-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .period-button {
            padding: 10px 20px;
            background: rgba(45, 55, 72, 0.8);
            border: 1px solid #4a5568;
            color: #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .period-button:hover {
            background: rgba(74, 85, 104, 0.8);
        }

        .period-button.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ðŸ“Š CI/CD Analytics Dashboard</h1>
            <p>Advanced insights and predictions for your development pipeline</p>
        </div>

        <div class="period-selector">
            <button class="period-button" onclick="loadAnalytics('daily')">Daily</button>
            <button class="period-button active" onclick="loadAnalytics('weekly')">Weekly</button>
            <button class="period-button" onclick="loadAnalytics('monthly')">Monthly</button>
        </div>

        <div class="analytics-grid">
            <!-- Key Metrics -->
            <div class="analytics-card">
                <div class="card-header">
                    <h3 class="card-title">Success Rate</h3>
                    <span class="card-badge badge-success" id="success-trend">â†‘</span>
                </div>
                <div class="metric-value" id="success-rate">--</div>
                <div class="metric-label">Build Success Rate</div>
                <div class="metric-change change-positive" id="success-change">--</div>
            </div>

            <div class="analytics-card">
                <div class="card-header">
                    <h3 class="card-title">Avg Duration</h3>
                    <span class="card-badge badge-info" id="duration-trend">â†’</span>
                </div>
                <div class="metric-value" id="avg-duration">--</div>
                <div class="metric-label">Minutes per Build</div>
                <div class="metric-change" id="duration-change">--</div>
            </div>

            <div class="analytics-card">
                <div class="card-header">
                    <h3 class="card-title">Total Cost</h3>
                    <span class="card-badge badge-warning" id="cost-trend">â†‘</span>
                </div>
                <div class="metric-value" id="total-cost">--</div>
                <div class="metric-label">Estimated CI/CD Spend</div>
                <div class="metric-change" id="cost-change">--</div>
            </div>

            <!-- Trends Chart -->
            <div class="analytics-card full-width">
                <div class="card-header">
                    <h3 class="card-title">Pipeline Trends</h3>
                </div>
                <div class="chart-container">
                    <canvas id="trends-chart"></canvas>
                </div>
            </div>

            <!-- Insights -->
            <div class="analytics-card">
                <div class="card-header">
                    <h3 class="card-title">Key Insights</h3>
                </div>
                <ul class="insights-list" id="insights-list">
                    <li class="insight-item">Loading insights...</li>
                </ul>
            </div>

            <!-- Anomalies -->
            <div class="analytics-card">
                <div class="card-header">
                    <h3 class="card-title">Anomalies Detected</h3>
                </div>
                <div class="anomaly-list" id="anomaly-list">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Predictions -->
            <div class="analytics-card">
                <div class="card-header">
                    <h3 class="card-title">Predictions</h3>
                </div>
                <div id="predictions-container">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <!-- Cost Analysis -->
            <div class="analytics-card">
                <div class="card-header">
                    <h3 class="card-title">Cost Breakdown</h3>
                </div>
                <div class="cost-breakdown" id="cost-breakdown">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="cost-chart"></canvas>
                </div>
            </div>

            <!-- Savings Opportunities -->
            <div class="analytics-card full-width">
                <div class="card-header">
                    <h3 class="card-title">ðŸ’° Savings Opportunities</h3>
                </div>
                <ul class="savings-list" id="savings-list">
                    <li class="savings-item">Analyzing cost patterns...</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3033';
        let trendsChart = null;
        let costChart = null;

        async function loadAnalytics(period = 'weekly') {
            // Update button states
            document.querySelectorAll('.period-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target?.classList.add('active');

            try {
                // Fetch analytics report
                const response = await fetch(`${API_BASE}/api/analytics/report?period=${period}`);
                const report = await response.json();

                // Update metrics
                updateKeyMetrics(report);

                // Update charts
                updateTrendsChart(report.trends);

                // Update insights
                updateInsights(report.insights);

                // Update anomalies
                updateAnomalies(report.anomalies);

                // Update predictions
                updatePredictions(report.predictions);

                // Update cost analysis
                updateCostAnalysis(report.costAnalysis);

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function updateKeyMetrics(report) {
            const latestTrend = report.trends[report.trends.length - 1];
            const previousTrend = report.trends[report.trends.length - 8]; // Week ago

            // Success Rate
            document.getElementById('success-rate').textContent =
                latestTrend ? `${latestTrend.successRate.toFixed(1)}%` : '--';

            const successChange = latestTrend && previousTrend ?
                latestTrend.successRate - previousTrend.successRate : 0;
            document.getElementById('success-change').textContent =
                `${successChange > 0 ? '+' : ''}${successChange.toFixed(1)}% vs last week`;
            document.getElementById('success-change').className =
                `metric-change ${successChange >= 0 ? 'change-positive' : 'change-negative'}`;

            // Average Duration
            document.getElementById('avg-duration').textContent =
                latestTrend ? `${latestTrend.avgDuration.toFixed(1)}` : '--';

            const durationChange = latestTrend && previousTrend ?
                ((latestTrend.avgDuration - previousTrend.avgDuration) / previousTrend.avgDuration * 100) : 0;
            document.getElementById('duration-change').textContent =
                `${durationChange > 0 ? '+' : ''}${durationChange.toFixed(1)}% vs last week`;

            // Total Cost
            document.getElementById('total-cost').textContent =
                report.costAnalysis ? `$${report.costAnalysis.totalCost.toFixed(2)}` : '--';
        }

        function updateTrendsChart(trends) {
            const ctx = document.getElementById('trends-chart').getContext('2d');

            if (trendsChart) {
                trendsChart.destroy();
            }

            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trends.map(t => new Date(t.date).toLocaleDateString()),
                    datasets: [
                        {
                            label: 'Success Rate (%)',
                            data: trends.map(t => t.successRate),
                            borderColor: '#48bb78',
                            backgroundColor: 'rgba(72, 187, 120, 0.1)',
                            yAxisID: 'y',
                            tension: 0.3
                        },
                        {
                            label: 'Total Builds',
                            data: trends.map(t => t.totalBuilds),
                            borderColor: '#4299e1',
                            backgroundColor: 'rgba(66, 153, 225, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#e2e8f0' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#2d3748' },
                            ticks: { color: '#a0aec0' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: '#2d3748' },
                            ticks: { color: '#a0aec0' },
                            title: {
                                display: true,
                                text: 'Success Rate (%)',
                                color: '#a0aec0'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            ticks: { color: '#a0aec0' },
                            title: {
                                display: true,
                                text: 'Build Count',
                                color: '#a0aec0'
                            }
                        }
                    }
                }
            });
        }

        function updateInsights(insights) {
            const container = document.getElementById('insights-list');

            if (!insights || insights.length === 0) {
                container.innerHTML = '<li class="insight-item">No significant insights detected</li>';
                return;
            }

            container.innerHTML = insights.map(insight => `
                <li class="insight-item ${insight.type}">
                    <strong>${insight.title}</strong><br>
                    <small>${insight.description}</small>
                </li>
            `).join('');
        }

        function updateAnomalies(anomalies) {
            const container = document.getElementById('anomaly-list');

            if (!anomalies || anomalies.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #48bb78;">âœ“ No anomalies detected</div>';
                return;
            }

            container.innerHTML = anomalies.map(anomaly => `
                <div class="anomaly-item ${anomaly.severity}">
                    <strong>${anomaly.type.replace('_', ' ').toUpperCase()}</strong><br>
                    <small>${anomaly.description}</small><br>
                    <small style="color: #a0aec0;">
                        Value: ${anomaly.value.toFixed(2)} |
                        Expected: ${anomaly.expectedRange.min.toFixed(0)}-${anomaly.expectedRange.max.toFixed(0)}
                    </small>
                </div>
            `).join('');
        }

        function updatePredictions(predictions) {
            const container = document.getElementById('predictions-container');

            if (!predictions || predictions.length === 0) {
                container.innerHTML = '<div>Insufficient data for predictions</div>';
                return;
            }

            container.innerHTML = predictions.map(pred => `
                <div class="prediction-card">
                    <strong>${pred.metric.replace('_', ' ').toUpperCase()}</strong><br>
                    <div style="font-size: 1.5rem; margin: 10px 0;">
                        ${pred.predictedValue.toFixed(1)}${pred.metric.includes('rate') ? '%' : ''}
                    </div>
                    <small>
                        Trend: <span style="color: ${pred.trend === 'improving' ? '#48bb78' :
                                                     pred.trend === 'degrading' ? '#f56565' : '#a0aec0'}">
                            ${pred.trend.toUpperCase()}
                        </span><br>
                        Confidence: ${(pred.confidence * 100).toFixed(0)}%
                    </small>
                </div>
            `).join('');
        }

        function updateCostAnalysis(costAnalysis) {
            if (!costAnalysis) return;

            // Update cost breakdown
            const breakdown = document.getElementById('cost-breakdown');
            breakdown.innerHTML = `
                <div class="cost-item">
                    <span>Total Cost</span>
                    <strong>$${costAnalysis.totalCost.toFixed(2)}</strong>
                </div>
                <div class="cost-item">
                    <span>Cost per Build</span>
                    <strong>$${costAnalysis.costPerBuild.toFixed(3)}</strong>
                </div>
            `;

            // Update cost chart
            const ctx = document.getElementById('cost-chart').getContext('2d');
            if (costChart) {
                costChart.destroy();
            }

            costChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(costAnalysis.costByPlatform),
                    datasets: [{
                        data: Object.values(costAnalysis.costByPlatform),
                        backgroundColor: ['#4299e1', '#48bb78', '#ed8936']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e2e8f0' }
                        }
                    }
                }
            });

            // Update savings opportunities
            const savingsList = document.getElementById('savings-list');
            savingsList.innerHTML = costAnalysis.savingsOpportunities.map(opportunity =>
                `<li class="savings-item">${opportunity}</li>`
            ).join('') || '<li class="savings-item">No immediate savings opportunities identified</li>';
        }

        // Load initial data
        loadAnalytics('weekly');

        // Refresh every 5 minutes
        setInterval(() => loadAnalytics('weekly'), 5 * 60 * 1000);
    </script>
</body>
</html>